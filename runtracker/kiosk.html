<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Stats Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Force fixed full screen, no scrollbars */
        body, html {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen w-screen flex flex-col overflow-hidden">

    <nav class="bg-gray-800 border-b border-gray-700 p-4 shadow-xl flex-none z-50">
        <div class="max-w-[98%] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <i class="fa-solid fa-chart-pie text-red-500 text-3xl"></i>
                <div>
                    <h1 class="font-bold text-2xl tracking-wide uppercase leading-none">Live Department Statistics</h1>
                    <div id="connectionStatus" class="text-xs text-yellow-500 flex items-center gap-1 mt-1">
                        <i class="fa-solid fa-circle text-[8px] animate-pulse"></i> Connecting...
                    </div>
                </div>
            </div>
            
            <div class="hidden md:block">
                 <h2 id="statsTitle" class="text-3xl font-bold text-gray-500 opacity-30 uppercase tracking-[0.2em]">2026 Statistics</h2>
            </div>
            
            </div>
    </nav>

    <main class="flex-grow p-6 w-full max-w-[98%] mx-auto fade-in flex flex-col min-h-0">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 flex-none">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg flex items-center justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-2 bg-white"></div>
                <div>
                    <h3 class="text-gray-400 text-sm uppercase font-bold tracking-wider mb-1">Total Calls</h3>
                    <p class="text-5xl font-bold text-white" id="stat-total">0</p>
                </div>
                <i class="fa-solid fa-phone text-gray-700 text-6xl opacity-20 group-hover:opacity-30 transition-opacity"></i>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg flex items-center justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-2 bg-red-600"></div>
                <div>
                    <h3 class="text-gray-400 text-sm uppercase font-bold tracking-wider mb-1">Fire Runs</h3>
                    <p class="text-5xl font-bold text-red-500" id="stat-fire">0</p>
                </div>
                <i class="fa-solid fa-fire text-red-900 text-6xl opacity-20 group-hover:opacity-30 transition-opacity"></i>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg flex items-center justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 h-full w-2 bg-blue-500"></div>
                <div>
                    <h3 class="text-gray-400 text-sm uppercase font-bold tracking-wider mb-1">EMS Runs</h3>
                    <p class="text-5xl font-bold text-blue-400" id="stat-ems">0</p>
                </div>
                <i class="fa-solid fa-star-of-life text-blue-900 text-6xl opacity-20 group-hover:opacity-30 transition-opacity"></i>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
            
            <div class="flex flex-col gap-6 h-full min-h-0">
                <div id="widget-natures" class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg p-5 flex-1 flex flex-col min-h-0">
                    <h3 class="font-bold text-lg text-white mb-3 uppercase border-b border-gray-700 pb-2 flex-none flex items-center gap-2">
                        <i class="fa-solid fa-list-ol text-gray-500"></i> Top Natures
                    </h3>
                    <div id="stats-natures" class="space-y-3 overflow-hidden flex-1">
                        <div class="text-gray-500 text-sm italic">Loading...</div>
                    </div>
                </div>

                <div id="widget-addresses" class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg p-5 flex-1 flex flex-col min-h-0">
                    <h3 class="font-bold text-lg text-white mb-3 uppercase border-b border-gray-700 pb-2 flex-none flex items-center gap-2">
                        <i class="fa-solid fa-map-location-dot text-gray-500"></i> Frequent Locations
                    </h3>
                    <div id="stats-addresses" class="space-y-3 overflow-hidden flex-1">
                        <div class="text-gray-500 text-sm italic">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-6 h-full min-h-0">
                <div id="widget-districts" class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg p-5 flex-none">
                    <h3 class="font-bold text-lg text-white mb-3 uppercase border-b border-gray-700 pb-2 flex-none flex items-center gap-2">
                        <i class="fa-solid fa-map text-gray-500"></i> District Analysis
                    </h3>
                    <div id="stats-districts" class="space-y-3">
                        <div class="text-gray-500 text-sm italic">Loading...</div>
                    </div>
                </div>

                <div id="widget-voldispo" class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg p-5 flex-1 flex flex-col min-h-0">
                    <h3 class="font-bold text-lg text-white mb-3 uppercase border-b border-gray-700 pb-2 flex-none flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check text-gray-500"></i> EMS Disposition Analysis
                    </h3>
                    <div id="stats-vol-dispo" class="space-y-3 overflow-hidden flex-1">
                        <div class="text-gray-500 text-sm italic">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-6 h-full min-h-0">
                 <div id="widget-mutual" class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg p-5 flex-1 flex flex-col min-h-0">
                    <h3 class="font-bold text-lg text-white mb-3 uppercase border-b border-gray-700 pb-2 flex-none flex items-center gap-2">
                        <i class="fa-solid fa-handshake text-gray-500"></i> Mutual Aid
                    </h3>
                    <div class="grid grid-cols-2 gap-4 mb-4 flex-none">
                        <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700 text-center relative overflow-hidden">
                            <i class="fa-solid fa-arrow-right-from-bracket absolute top-1 right-2 text-gray-700 opacity-30 text-2xl"></i>
                            <span class="block text-gray-400 text-xs uppercase font-bold mb-1">Given</span>
                            <span id="stat-ma-given" class="text-3xl font-bold text-yellow-400 block">0</span>
                        </div>

                        <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700 text-center relative overflow-hidden">
                            <i class="fa-solid fa-arrow-right-to-bracket absolute top-1 right-2 text-gray-700 opacity-30 text-2xl"></i>
                            <span class="block text-gray-400 text-xs uppercase font-bold mb-1">Received</span>
                            <span id="stat-ma-received" class="text-3xl font-bold text-green-400 block">0</span>
                        </div>
                    </div>
                    
                    <div class="flex-1 min-h-0 grid grid-cols-2 gap-4 border-t border-gray-700 pt-3">
                        <div class="flex flex-col min-h-0">
                            <h4 class="text-xs text-yellow-500 uppercase font-bold mb-2 flex-none"><i class="fa-solid fa-arrow-right mr-1"></i> Given To</h4>
                            <ul id="stats-ma-given-list" class="text-sm space-y-2 text-gray-300 overflow-hidden flex-1">
                                </ul>
                        </div>
                        <div class="flex flex-col min-h-0">
                            <h4 class="text-xs text-green-500 uppercase font-bold mb-2 flex-none"><i class="fa-solid fa-arrow-left mr-1"></i> Rec'd From</h4>
                            <ul id="stats-ma-received-list" class="text-sm space-y-2 text-gray-300 overflow-hidden flex-1">
                                </ul>
                        </div>
                    </div>
                </div>
             </div>

        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyCxer4UcW04LXNXZe3WdjTAi6C64P18VJE",
          authDomain: "spfld-twp-fire.firebaseapp.com",
          projectId: "spfld-twp-fire",
          storageBucket: "spfld-twp-fire.firebasestorage.app",
          messagingSenderId: "625097083856",
          appId: "1:625097083856:web:2703d29764be68eab6c7d5",
          measurementId: "G-5JDF2SZVGZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- State ---
        let allCalls = [];
        let currentStatsYear = new Date().getFullYear();
        let currentConfig = {
            statsConfig: { 
                showNatures: true,
                showAddresses: true,
                showMutual: true,
                showCrew: false, // OFF by default
                showVolDispo: true,
                limit: 8 // Higher default limit for Kiosk
            }
        };

        // --- Auth & Init ---
        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('connectionStatus').innerHTML = '<span class="text-red-500 uppercase font-bold">Offline</span>';
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('connectionStatus').innerHTML = '<span class="text-green-500 font-bold uppercase">Live</span>';
                setupRealtimeListener();
                loadConfiguration(); 
            }
        });

        initApp();

        // --- LOAD DYNAMIC OPTIONS ---
        async function loadConfiguration() {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'callTrackerConfig', 'options');
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    
                    if (data.stats) {
                        currentConfig.statsConfig = { ...currentConfig.statsConfig, ...data.stats };
                        // Force a higher limit for kiosk if not explicitly set high
                        if(!data.stats.limit || data.stats.limit < 8) currentConfig.statsConfig.limit = 8;
                    }
                    
                    updateStats();
                }
            } catch (e) {
                console.error("Failed to load config options", e);
            }
        }

        // --- Firestore Listener ---
        function setupRealtimeListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'calls');

            onSnapshot(q, (snapshot) => {
                const calls = [];
                snapshot.forEach((doc) => {
                    calls.push({ id: doc.id, ...doc.data() });
                });

                allCalls = calls;
                updateStats();
            }, (error) => {
                console.error("Firestore Error:", error);
                document.getElementById('connectionStatus').innerHTML = '<span class="text-red-500 uppercase">Data Error</span>';
            });
        }

        // --- Rendering Logic ---
        function updateStats() {
            // Filter by the currently selected year state
            const thisYearCalls = allCalls.filter(c => c.year === currentStatsYear);
            
            // 1. Basic Counts
            document.getElementById('stat-total').textContent = thisYearCalls.length;
            
            const fireCount = thisYearCalls.filter(c => c.responseType === 'Fire' || c.responseType === 'Both').length;
            const emsCount = thisYearCalls.filter(c => c.responseType === 'EMS' || c.responseType === 'Both').length;
            
            document.getElementById('stat-fire').textContent = fireCount;
            document.getElementById('stat-ems').textContent = emsCount;

            const config = currentConfig.statsConfig;
            const limit = config.limit || 8;

            // 2. Top Natures
            const wNatures = document.getElementById('widget-natures');
            if (config.showNatures) {
                wNatures.classList.remove('hidden');
                
                const natureCounts = {};
                thisYearCalls.forEach(c => {
                    const n = c.callNature || 'UNKNOWN';
                    natureCounts[n] = (natureCounts[n] || 0) + 1;
                });
                
                const sortedNatures = Object.entries(natureCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, limit); 

                const natureListEl = document.getElementById('stats-natures');
                natureListEl.innerHTML = '';
                
                if (sortedNatures.length === 0) {
                    natureListEl.innerHTML = '<div class="text-gray-500 text-sm italic">No data available</div>';
                } else {
                    const maxCount = sortedNatures[0][1];
                    sortedNatures.forEach(([name, count]) => {
                        const barWidth = (count / maxCount) * 100; 
                        const row = document.createElement('div');
                        row.innerHTML = `
                            <div class="flex justify-between text-xs mb-1 uppercase font-semibold text-gray-300">
                                <span>${name}</span>
                                <span>${count}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div class="bg-blue-500 h-3 rounded-full transition-all duration-500 shadow-md shadow-blue-500/30" style="width: ${barWidth}%"></div>
                            </div>
                        `;
                        natureListEl.appendChild(row);
                    });
                }
            } else {
                wNatures.classList.add('hidden');
            }

            // 3. Top Addresses
            const wAddresses = document.getElementById('widget-addresses');
            if (config.showAddresses) {
                wAddresses.classList.remove('hidden');
                const addressCounts = {};
                thisYearCalls.forEach(c => {
                    let addr = c.address ? c.address.trim().toUpperCase() : 'UNKNOWN';
                    if (addr.includes('I 70')) addr = 'I 70'; 
                    if (addr !== 'UNKNOWN' && addr !== '') addressCounts[addr] = (addressCounts[addr] || 0) + 1;
                });

                const sortedAddresses = Object.entries(addressCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, limit); 

                const addrListEl = document.getElementById('stats-addresses');
                addrListEl.innerHTML = '';

                if (sortedAddresses.length === 0) {
                    addrListEl.innerHTML = '<div class="text-gray-500 text-sm italic">No data available</div>';
                } else {
                    const maxAddrCount = sortedAddresses[0][1];
                    sortedAddresses.forEach(([addr, count]) => {
                        const barWidth = (count / maxAddrCount) * 100;
                        const row = document.createElement('div');
                        row.innerHTML = `
                            <div class="flex justify-between text-xs mb-1 uppercase font-semibold text-gray-300">
                                <span class="truncate pr-2" title="${addr}">${addr}</span>
                                <span>${count}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div class="bg-purple-500 h-3 rounded-full transition-all duration-500 shadow-md shadow-purple-500/30" style="width: ${barWidth}%"></div>
                            </div>
                        `;
                        addrListEl.appendChild(row);
                    });
                }
            } else {
                wAddresses.classList.add('hidden');
            }

            // 4. Mutual Aid Breakdown
            const wMutual = document.getElementById('widget-mutual');
            if (config.showMutual) {
                wMutual.classList.remove('hidden');
                let givenCount = 0;
                let receivedCount = 0;
                
                const maGivenDepts = {};
                const maReceivedDepts = {};

                thisYearCalls.forEach(c => {
                    // Removed: if (c.responseType === 'Fire') return;
                    // Now tracking mutual aid for ALL types
                    if (c.mutualAid) {
                        if (c.mutualAidType === 'Given') {
                            givenCount++;
                        }
                        if (c.mutualAidType === 'Received') {
                            receivedCount++;
                        }
                        if (c.mutualAidDept) {
                            const depts = c.mutualAidDept.split(',').map(s => s.trim());
                            depts.forEach(d => { 
                                if(!d) return;
                                if(c.mutualAidType === 'Given') {
                                    maGivenDepts[d] = (maGivenDepts[d] || 0) + 1;
                                } else {
                                    maReceivedDepts[d] = (maReceivedDepts[d] || 0) + 1;
                                }
                            });
                        }
                    }
                });

                document.getElementById('stat-ma-given').textContent = givenCount;
                document.getElementById('stat-ma-received').textContent = receivedCount;

                // Render Given List
                const sortedGiven = Object.entries(maGivenDepts).sort((a, b) => b[1] - a[1]).slice(0, limit); 
                const givenListEl = document.getElementById('stats-ma-given-list');
                givenListEl.innerHTML = '';
                
                if (sortedGiven.length === 0) {
                    givenListEl.innerHTML = '<li class="text-gray-500 text-xs italic">No data</li>';
                } else {
                    sortedGiven.forEach(([name, count]) => {
                        const li = document.createElement('li');
                        li.className = "flex justify-between border-b border-gray-700 py-2 last:border-0 items-center";
                        li.innerHTML = `<span class="uppercase font-medium truncate pr-2 text-xs" title="${name}">${name}</span> <span class="bg-gray-700 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">${count}</span>`;
                        givenListEl.appendChild(li);
                    });
                }

                // Render Received List
                const sortedReceived = Object.entries(maReceivedDepts).sort((a, b) => b[1] - a[1]).slice(0, limit); 
                const receivedListEl = document.getElementById('stats-ma-received-list');
                receivedListEl.innerHTML = '';
                
                if (sortedReceived.length === 0) {
                    receivedListEl.innerHTML = '<li class="text-gray-500 text-xs italic">No data</li>';
                } else {
                    sortedReceived.forEach(([name, count]) => {
                        const li = document.createElement('li');
                        li.className = "flex justify-between border-b border-gray-700 py-2 last:border-0 items-center";
                        li.innerHTML = `<span class="uppercase font-medium truncate pr-2 text-xs" title="${name}">${name}</span> <span class="bg-gray-700 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">${count}</span>`;
                        receivedListEl.appendChild(li);
                    });
                }

            } else {
                wMutual.classList.add('hidden');
            }

            // 5. DISTRICT STATS (NEW)
            const wDistricts = document.getElementById('widget-districts');
            if(wDistricts) {
                 const distCounts = {};
                 thisYearCalls.forEach(c => {
                     const d = c.district || 'UNSPECIFIED';
                     distCounts[d] = (distCounts[d] || 0) + 1;
                 });
                 
                 const sortedDist = Object.entries(distCounts).sort((a,b) => b[1] - a[1]);
                 const distListEl = document.getElementById('stats-districts');
                 distListEl.innerHTML = '';
                 
                 if (sortedDist.length === 0) {
                     distListEl.innerHTML = '<div class="text-gray-500 text-sm italic">No data available</div>';
                 } else {
                     const maxCount = sortedDist[0][1];
                     sortedDist.forEach(([name, count]) => {
                         const barWidth = (count / maxCount) * 100;
                         const row = document.createElement('div');
                         row.innerHTML = `
                            <div class="flex justify-between text-xs mb-1 uppercase font-semibold text-gray-300">
                                <span>${name}</span>
                                <span>${count}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div class="bg-indigo-500 h-3 rounded-full transition-all duration-500 shadow-md shadow-indigo-500/30" style="width: ${barWidth}%"></div>
                            </div>
                         `;
                         distListEl.appendChild(row);
                     });
                 }
            }

            // 6. Crew Analysis (Hidden) & Disposition Stats
            const wCrew = document.getElementById('widget-crew'); // Likely hidden or removed in HTML
            const wVolDispo = document.getElementById('widget-voldispo');

            const volDispCounts = {};

            thisYearCalls.forEach(c => {
                if (c.responseType === 'Fire') return;
                const disp = c.emsDisposition || 'NOT RECORDED';
                volDispCounts[disp] = (volDispCounts[disp] || 0) + 1;
            });

            // Keep crew logic hidden
            if (wCrew) wCrew.classList.add('hidden');

            if (config.showVolDispo) {
                wVolDispo.classList.remove('hidden');
                const volDispListEl = document.getElementById('stats-vol-dispo');
                volDispListEl.innerHTML = '';
                const sortedVolDisps = Object.entries(volDispCounts).sort((a, b) => b[1] - a[1]);

                if (sortedVolDisps.length === 0) {
                    volDispListEl.innerHTML = '<div class="text-gray-500 text-sm italic">No data available</div>';
                } else {
                    const maxCount = sortedVolDisps[0][1];
                    sortedVolDisps.forEach(([name, count]) => {
                        const barWidth = (count / maxCount) * 100;
                        const row = document.createElement('div');
                        row.innerHTML = `
                            <div class="flex justify-between text-xs mb-1 uppercase font-semibold text-gray-300">
                                <span>${name}</span>
                                <span>${count}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div class="bg-orange-500 h-3 rounded-full transition-all duration-500 shadow-md shadow-orange-500/30" style="width: ${barWidth}%"></div>
                            </div>
                        `;
                        volDispListEl.appendChild(row);
                    });
                }
            } else {
                wVolDispo.classList.add('hidden');
            }
        }
    </script>
</body>
</html>